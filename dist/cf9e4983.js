class e{constructor(e){this.headperiod=e.headperiod,this.tailperiod=e.tailperiod,this.starttime=(new Date).getTime()}putLog(e,t,i){const n={dt:new Date,log:i},s=n.dt.getTime();null!==e&&s<this.starttime+this.headperiod&&e.push(n),t.push(n);const a=t.length;let r=0;for(let e=0;e<a&&!(s-this.tailperiod<t[e].dt.getTime());e++)r++;return 0!==r&&t.splice(0,r),t}}class t{constructor(e){this.id=e,this.labeledHistories=[]}dumpMerged(){let e=[];this.labeledHistories.forEach((t=>{e=e.concat(t.history.map((e=>({target:t.target,prop:t.prop,dt:e.dt,log:e.log}))))})),e.sort(((e,t)=>e.dt<t.dt?-1:e.dt>t.dt?1:0));let t=`${this.id}:\n`;return e.forEach((e=>{t+=`[${e.dt.toISOString()}]\t${e.target}\t${e.prop}\t${e.log}\n`})),t}addHistory(e,t,i){this.labeledHistories.push({target:e,prop:t,history:i})}}class i extends RTCPeerConnection{constructor(e,t,n){super(t),Object.setPrototypeOf(this,i.prototype),this.logger=n,this.connectionStateLatest="initial",this.connectionStateHeadHistory=[],this.connectionStateTailHistory=[],this.signalingStateLatest="initial",this.signalingStateHeadHistory=[],this.signalingStateTailHistory=[],this.iceConnectionStateLatest="initial",this.iceConnectionStateHeadHistory=[],this.iceConnectionStateTailHistory=[],this.iceGatheringStateLatest="initial",this.iceGatheringStateHeadHistory=[],this.iceGatheringStateTailHistory=[],this.iceEventHeadHistory=[],this.iceEventTailHistory=[],this.statsHistory=[],this.iceInfo=[],this.connection_id=e,this.startTime=(new Date).getTime(),this.iceConnectState="initial",this.on("signalingstatechange",(()=>{this.signalingStateTailHistory=this.logger.putLog(this.signalingStateHeadHistory,this.signalingStateTailHistory,`${this.signalingState} <- ${this.signalingStateLatest}`),this.signalingStateLatest=this.signalingState})),this.on("iceconnectionstatechange",(()=>{this.iceConnectionStateTailHistory=this.logger.putLog(this.iceConnectionStateHeadHistory,this.iceConnectionStateTailHistory,`${this.iceConnectionState} <- ${this.iceConnectionStateLatest}`),this.iceConnectionStateLatest=this.iceConnectionState,"connected"===this.iceConnectionState&&(this.iceConnectState="connected")})),this.on("icegatheringstatechange",(()=>{this.iceGatheringStateTailHistory=this.logger.putLog(this.iceGatheringStateHeadHistory,this.iceGatheringStateTailHistory,`${this.iceGatheringState} <- ${this.iceGatheringStateLatest}`),this.iceGatheqingStateLatest=this.iceGatheringState})),this.on("connectionstatechange",(()=>{this.connectionStateTailHistory=this.logger.putLog(this.connectionStateHeadHistory,this.connectionStateTailHistory,`${this.connectionState} <- ${this.connectionStateLatest}`),this.connectionStateLatest=this.connectionState})),this.on("icecandidateerror",(e=>{this.iceEventTailHistory=this.logger.putLog(this.iceEventHeadHistory,this.iceEventTailHistory,`icecandidateerror(${e.errorCode}) ${e.errorText}`),600!==e.errorCode&&701!==e.errorCode&&console.error(e)})),this.remoteSDP=new Promise((e=>{const t=()=>{this.remoteDescription&&(this.removeEventListener("signalingstatechange",t),e())};this.addEventListener("signalingstatechange",t)})),this.remote_track_metadata=[],this.timerid=window.setInterval(this.monitor.bind(this),2500),this.stability="stable"}setRemoteTrackMetadata(e){if(!this.remote_track_metadata)return void(this.remote_track_metadata=e);const t=this.remote_track_metadata.reduce(((e,t)=>(e[t.track_id]={track:t.track,stream:t.stream},e)),{});this.remote_track_metadata=e,this.remote_track_metadata.forEach((e=>{const i=t[e.track_id];i&&(e.track=i.track,e.stream=i.stream)}))}assignTrackIdToTrack(e,t){const i=e.filter((e=>"video"===e.kind)).map((e=>e.track_id)),n=e.filter((e=>"audio"===e.kind)).map((e=>e.track_id));t.forEach((e=>{const t="video"===e.mediaStreamTrack.kind?i.shift():n.shift();t&&(e.track_id=t)}))}makeLocalTrackMeta(e,t){return e.map((e=>{const i=e.track_id,n=t.find((e=>e.track_id===i));if(!n)return{track_id:i};const s=Object.entries(n.meta).map((([e,t])=>({name:e,value:t,source:"app_front",use_notification:!0})));return s.push({name:"muteState",value:n.getMuteState(),source:"sdk",use_notification:!0}),{track_id:i,tags:s}}))}on(e,t){this.addEventListener(e,(e=>{const i=e instanceof CustomEvent?e.detail:e;t(i)}))}emit(e,t){this.dispatchEvent(new CustomEvent(e,{detail:t}))}addTracks(e){return new Promise((t=>{this.on("negotiationneeded",t),e.forEach((e=>{this.addTrack(e.mediaStreamTrack,e.stream),e.addSenders(this)}))}))}getConnectionStats(e){return(e?this.getStats(e):this.getStats()).then((e=>({connection_id:this.connection_id?this.connection_id:"sfu",report:e})))}async getOffer(e){return await this.setLocalDescription(await super.createOffer(e)),new RTCSessionDescription(this.localDescription)}async getAnswer(e,t){return await this.setRemoteDescription(e),await this.setLocalDescription(await super.createAnswer()),new RTCSessionDescription(this.localDescription)}async setAnswer(e){await this.setRemoteDescription(e)}async setIceCandidate(e){await this.remoteSDP,await super.addIceCandidate(e)}getIceInfo(e){const t=[],i={};e.forEach((e=>{if("candidate-pair"===e.type){const{id:i,localCandidateId:n,availableOutgoingBitrate:s,availableIncomingBitrate:a}=e;t.push({id:i,localCandidateId:n,availableOutgoingBitrate:s,availableIncomingBitrate:a})}else if("local-candidate"===e.type){const{networkType:t,protocol:n,relayProtocol:s,candidateType:a}=e;i[e.id]={networkType:t,protocol:n,relayProtocol:s,candidateType:a}}})),t.forEach((e=>{const{networkType:t,protocol:n,relayProtocol:s,candidateType:a}=i[e.localCandidateId],{id:r,availableOutgoingBitrate:o,availableIncomingBitrate:c}=e;this.iceInfo.push({id:r,availableOutgoingBitrate:o,availableIncomingBitrate:c,networkType:t,protocol:n,relayProtocol:s,candidateType:a})}))}async monitor(){const e=await this.getStats(),t=[];if(e.forEach((e=>{t.push(e)})),this.statsHistory=this.logger.putLog(null,this.statsHistory,JSON.stringify(t)),this.getIceInfo(e),"initial"===this.iceConnectState){3e4<(new Date).getTime()-this.startTime&&(this.emit("changestability",{connection_id:this.connection_id,stability:"iceconnecttimeout"}),this.iceConnectState="timeout")}"connected"===this.connectionState&&"unstable"===this.stability?(this.stability="stable",this.emit("changestability",{connection_id:this.connection_id,stability:"icestable"})):"disconnected"===this.connectionState&&"stable"===this.stability&&(this.stability="unstable",this.emit("changestability",{connection_id:this.connection_id,stability:"iceunstable"}))}stop(){window.clearInterval(this.timerid)}}class n extends WebSocket{constructor(e,t,i){super(e,i),Object.setPrototypeOf(this,n.prototype),this.addEventListener("message",this.onMessage.bind(this)),this.logger=t,this.sendHeadHistory=[],this.sendTailHistory=[],this.recvHeadHistory=[],this.recvTailHistory=[],this.lastReceived=(new Date).getTime()}onMessage(e){this.recvTailHistory=this.logger.putLog(this.recvHeadHistory,this.recvTailHistory,e.data),this.lastReceived=(new Date).getTime();const t=JSON.parse(e.data);this.dispatchEvent(new CustomEvent("_"+t.message_type,{detail:t}))}sendMessage(e){const t=JSON.stringify(e);super.send(t),this.sendTailHistory=this.logger.putLog(this.sendHeadHistory,this.sendTailHistory,t)}on(e,t){this.addEventListener("_"+e,(e=>{e instanceof CustomEvent&&t(e.detail)}))}}class s{constructor(e,t,i){this.mediaStreamTrack=e,this.stream=t,this.meta={},i.meta&&(this.meta=i.meta),this.muteType="unmute",i.mute&&(this.muteType=i.mute)}}class a{constructor(e){this.track_id="",this.muteType=e.muteType,this.mediaStreamTrack=e.mediaStreamTrack,this.senderMediaStreamTrack=e.mediaStreamTrack,this.meta=e.meta,this.stream=e.stream,this.lsTrack=e,this.senders=[],this.reservedFramerate=null}getMuteState(){return"softmute"===this.muteType?"blank":"hardmute"===this.muteType?"paused":"on"}addSenders(e){const t=e.getSenders().filter((e=>!!(e&&e.track&&e.track.kind)&&e.track.kind===this.mediaStreamTrack.kind));this.senders=this.senders.concat(t)}removeSenders(e){const t=e.getSenders().filter((e=>!!(e&&e.track&&e.track.kind)&&e.track.kind===this.mediaStreamTrack.kind));this.senders=this.senders.filter((e=>!t.includes(e)))}async replaceSenderTrack(e){this.senderMediaStreamTrack=e;for(let e in this.senders)await this.senders[e].replaceTrack(this.senderMediaStreamTrack)}changeFramerate(e){this.senders.forEach((t=>{if(null===t.track)return;if("video"!==t.track.kind)return;const i=t.getParameters();i.encodings||(i.encodings=[{}]),i.encodings[0]&&(i.encodings[0].maxFramerate=e),t.setParameters(i)})),this.senders.every((e=>null===e.track))&&(this.reservedFramerate=e)}updateEncodingParameters(){null!==this.reservedFramerate&&(this.changeFramerate(this.reservedFramerate),this.reservedFramerate=null)}}class r{constructor(e,t,i=null){this.code=e,this.error=t,this.detail=i;const n=Math.floor(e/1e4);this.type="UnexpectedError",4===n?this.type="ParameterError":5===n&&(this.type="NetworkError"),this.localtime=(new Date).getTime()}getDetail(){return{code:this.code,type:this.type,error:this.error}}toReportString(){let e=`ricoh-ls-sdk error dump\ntimestamp: ${this.localtime}\nerror: ${this.type} (${this.code}) ${this.error}\n`;return this.detail instanceof Error&&(e+="stack: "+this.detail.stack+"\n"),e+"detail:\n"+function e(t,i=0){if(i>2)return"Object";const n={};for(let s in t)n[s]=t[s]instanceof Object?e(t[s],i+1):t[s];return i?n:JSON.stringify(n)}(this.detail)}}class o extends Error{constructor(e){super(e.error),this.detail=e.getDetail(),this.errdata=e}toReportString(){return this.errdata.toReportString()}}class c extends CustomEvent{constructor(e){super("error",{detail:e.getDetail()}),this.errdata=e}toReportString(){return this.errdata.toReportString()}}class d extends class{constructor(){this.listeners=new Map}addEventListener(e,t,i={}){const n=this.listeners.get(e)||[];n.push({listener:t,options:i}),this.listeners.set(e,n)}dispatchEvent(e){(this.listeners.get(e.type)||[]).forEach((({listener:t,options:i})=>{t.call(this,e),i.once&&this.removeEventListener(e.type,t,i)}))}removeEventListener(e,t,i={}){const n=(this.listeners.get(e)||[]).filter((({listener:e})=>e!==t));this.listeners.set(e,n)}}{constructor(){super(),this.state="idle",this.rtcConfiguration={},this.room_session_id=null,this.localLSTracks=[],this.ws=null,this.peers=new Map,this.client_id=null,this.access_token=null,this.sfupc=null,this.connectionMetadata={},this.sendrecv="sendrecv",this.sendingOption=null,this.receivingOption=null,this.mutedVideoSenders=[],this.mutedAudioSenders=[],this.logger=null,this.stateHeadHistory=[],this.stateTailHistory=[],this.wsEventHeadHistory=[],this.wsEventTailHistory=[],this.debugInfoHeadHistory=[],this.debugInfoTailHistory=[],this.earlyCandidates=new Map,this.connections=new Map,this.userIceTransportPolicy=null,this.userIceServersProtocol=null,this.timerId=null,this.reservedFramerate=null}on(e,t){this.addEventListener(e,(e=>{e instanceof CustomEvent&&("error"===e.type?t(e):t(e.detail))}))}emit(e,t){this.dispatchEvent(new CustomEvent(e,{detail:t}))}emitError(e,t,i){this.dispatchEvent(new c(new r(e,t,i)))}internalError(e,t){const i="closing"===this.state||"closed"===this.state;if(this.disconnect(),!i){const i="InternalError"+e.toString();this.emitError(e,i,t)}}getState(){try{return this.state}catch(e){this.internalError(61002,e)}}getStats(e){try{const t=[];return this.peers.forEach((i=>t.push(i.getConnectionStats(e)))),this.sfupc&&t.push(this.sfupc.getConnectionStats(e)),Promise.all(t).then((e=>e.reduce(((e,t)=>(e[t.connection_id]=t.report,e)),{})))}catch(e){this.internalError(61003,e)}}getHeadReport(){const e=new t("first 5 minutes log");return e.addHistory("Client___","state_____________",this.stateHeadHistory),e.addHistory("Websocket","event_____________",this.wsEventHeadHistory),e.addHistory("Websocket","recvMessage_______",this.ws.recvHeadHistory),e.addHistory("Websocket","sendMessage_______",this.ws.sendHeadHistory),e.addHistory("DebugInfo","debugInfo_________",this.debugInfoHeadHistory),this.peers.forEach((t=>{e.addHistory(`Peer(${t.connection_id})`,"connectionState___",t.connectionStateHeadHistory),e.addHistory(`Peer(${t.connection_id})`,"signalingState____",t.signalingStateHeadHistory),e.addHistory(`Peer(${t.connection_id})`,"iceGatheringState_",t.iceGatheringStateHeadHistory),e.addHistory(`Peer(${t.connection_id})`,"iceConnectionState",t.iceConnectionStateHeadHistory),e.addHistory(`Peer(${t.connection_id})`,"iceEvent__________",t.iceEventHeadHistory)})),this.sfupc&&(e.addHistory("Peer(sfu)","connectionState___",this.sfupc.connectionStateHeadHistory),e.addHistory("Peer(sfu)","signalingState____",this.sfupc.signalingStateHeadHistory),e.addHistory("Peer(sfu)","iceGatheringState_",this.sfupc.iceGatheringStateHeadHistory),e.addHistory("Peer(sfu)","iceConnectionState",this.sfupc.iceConnectionStateHeadHistory),e.addHistory("Peer(sfu)","iceEvent__________",this.sfupc.iceEventHeadHistory)),e.dumpMerged()}getTailReport(){this.sfupc&&this.sfupc.iceInfo.forEach((e=>{this.putLog("debug",JSON.stringify(e))}));const e=new t("last 5 minutes log");return e.addHistory("Client___","state_____________",this.stateTailHistory),e.addHistory("Websocket","event_____________",this.wsEventTailHistory),e.addHistory("Websocket","recvMessage_______",this.ws.recvTailHistory),e.addHistory("Websocket","sendMessage_______",this.ws.sendTailHistory),e.addHistory("DebugInfo","debugInfo_________",this.debugInfoTailHistory),this.peers.forEach((t=>{e.addHistory(`Peer(${t.connection_id})`,"connectionState___",t.connectionStateTailHistory),e.addHistory(`Peer(${t.connection_id})`,"signalingState____",t.signalingStateTailHistory),e.addHistory(`Peer(${t.connection_id})`,"iceGatheringState_",t.iceGatheringStateTailHistory),e.addHistory(`Peer(${t.connection_id})`,"iceConnectionState",t.iceConnectionStateTailHistory),e.addHistory(`Peer(${t.connection_id})`,"iceEvent__________",t.iceEventTailHistory)})),this.sfupc&&(e.addHistory("Peer(sfu)","connectionState___",this.sfupc.connectionStateTailHistory),e.addHistory("Peer(sfu)","signalingState____",this.sfupc.signalingStateTailHistory),e.addHistory("Peer(sfu)","iceGatheringState_",this.sfupc.iceGatheringStateTailHistory),e.addHistory("Peer(sfu)","iceConnectionState",this.sfupc.iceConnectionStateTailHistory),e.addHistory("Peer(sfu)","iceEvent__________",this.sfupc.iceEventTailHistory)),e.dumpMerged()}getStatsReport(){const e=new t("stats log");return this.peers.forEach((t=>{e.addHistory(`Peer(${t.connection_id})`,"stats",t.statsHistory)})),this.sfupc&&e.addHistory("Peer(sfu)","stats",this.sfupc.statsHistory),e.dumpMerged()}connect(t,i,s){if("idle"!==this.state)throw new o(new r(45e3,"BadStateOnConnect"));try{s.sending&&(this.sendingOption=s.sending),s.receiving&&(this.receivingOption=s.receiving),this.sendrecv=this.getSendRecvFromOption(s)}catch(e){return void this.internalError(61049,e)}if("sendrecv"===this.sendrecv||"sendonly"===this.sendrecv){if(!s.localLSTracks)throw new o(new r(45004,"NeedLocalTracksOnConnect"))}else if(s.localLSTracks)throw new o(new r(45014,"InvalidLocalTracksOnConnect"));try{this.timerId=window.setInterval(this.monitor.bind(this),2500),this.client_id=t,this.access_token=i,this.peers=new Map,s.meta&&(this.connectionMetadata=s.meta),s.iceTransportPolicy&&(this.userIceTransportPolicy=s.iceTransportPolicy),void 0!==s.iceServersProtocol&&(this.userIceServersProtocol=s.iceServersProtocol),this.logger=new e({headperiod:3e5,tailperiod:3e5}),this.putLog("debug",`UA: ${window.navigator.userAgent}`),this.putLog("debug",`API Call: connect - ${JSON.stringify(s)}`),this.ws=new n(s.signalingURL||"wss://signaling.livestreaming.mw.smart-integration.ricoh.com/v1/room",this.logger),this.setState("connecting","connecting"),this.ws.addEventListener("open",this.onWSOpen.bind(this)),this.ws.addEventListener("error",this.onWSError.bind(this)),this.ws.addEventListener("close",this.onWSClose.bind(this)),this.ws.on("connect_success",this.onConnectSuccess.bind(this)),this.ws.on("p2p.request_offer",this.onP2PRequestOffer.bind(this)),this.ws.on("p2p.relay_offer",this.onP2PRelayOffer.bind(this)),this.ws.on("p2p.relay_answer",this.onP2PRelayAnswer.bind(this)),this.ws.on("p2p.relay_icecandidate",this.onP2PRelayIcecandidate.bind(this)),this.ws.on("p2p.request_update_answer",this.onP2PRequestUpdateAnswer.bind(this)),this.ws.on("p2p.relay_update_answer",this.onP2PRelayUpdateAnswer.bind(this)),this.ws.on("sfu.offer",this.onSFUOffer.bind(this)),this.ws.on("sfu.relay_icecandidate",this.onSFURelayIcecandidate.bind(this)),this.ws.on("sfu.update_offer",this.onSFUUpdateOffer.bind(this)),this.ws.on("notify.connection.connect",this.onNotifyConnectionConnect.bind(this)),this.ws.on("notify.connection.leave",this.onNotifyConnectionLeave.bind(this)),this.ws.on("notify.connection.update",this.onNotifyConnectionUpdate.bind(this)),this.ws.on("notify.sfu.track.update",this.onNotifySFUTrackUpdate.bind(this)),this.ws.on("ping",this.onPing.bind(this)),this.ws.on("error",this.onError.bind(this)),this.ws.on("debug_info",this.onDebugInfo.bind(this))}catch(e){return void this.internalError(61004,e)}"sendrecv"!==this.sendrecv&&"sendonly"!==this.sendrecv||s.localLSTracks.forEach((e=>{this.localLSTracks.push(new a(e)),this.emit("addlocaltrack",{mediaStreamTrack:e.mediaStreamTrack,stream:e.stream})}))}disconnect(){try{this.putLog("debug","API Call: disconnect"),this.setState("closing","closing"),this.ws&&this.ws.close(1e3),this.sfupc&&(this.sfupc.close(),this.sfupc.stop(),this.sfupc=null),this.peers.forEach(((e,t)=>{e.close(),e.stop(),this.peers.delete(t)})),this.peers=new Map,this.timerId&&(window.clearInterval(this.timerId),this.timerId=null)}catch(e){this.internalError(61005,e)}}updateMeta(e){if(this.putLog("debug","API Call: updateMeta"),"open"!==this.state)throw new o(new r(45006,"BadStateOnUpdateMeta"));try{this.ws.sendMessage({message_type:"update_connection",tags:this.metaToTags(e)})}catch(e){this.internalError(61031,e)}}updateTrackMeta(e,t,i="app_front"){if(this.putLog("debug","API Call: updateTrackMeta"),"open"!==this.state)throw new o(new r(45007,"BadStateOnUpdateTrackMeta"));if(!this.sfupc)throw new o(new r(45002,"UnsupportedRoomSpecTypeOnUpdateTrackMeta"));const n=this.localLSTracks.find((t=>t.lsTrack===e));if(!n)throw new o(new r(45001,"TrackNotFoundOnUpdateTrackMeta"));try{this.ws.sendMessage({message_type:"sfu.update_track",track_id:n.track_id,tags:this.metaToTags(t,i)})}catch(e){this.internalError(61032,e)}}async replaceMediaStreamTrack(e,t){this.putLog("debug","API Call: replaceMediaStreamTrack");const i=this.localLSTracks.find((t=>t.lsTrack===e));if(!i)throw new o(new r(45009,"TrackNotFoundOnReplaceMediaStreamTrack"));try{await this.replaceLSTrack(t,i)}catch(e){this.internalError(61037,e)}}async changeMute(e,t){if(this.putLog("debug","API Call: changeMute"),"open"!==this.state)throw new o(new r(45005,"BadStateOnChangeMute"));const i=this.localLSTracks.find((t=>t.lsTrack===e));if(!i)throw new o(new r(45008,"TrackNotFoundOnChangeMute"));try{const n=i.muteType;if(n===t)return;await this.changeMuteState(n,t,i);const s=i.getMuteState();this.sfupc&&this.updateTrackMeta(e,{muteState:s},"sdk"),"unmute"===t&&i.updateEncodingParameters()}catch(e){this.internalError(61040,e)}}changeMediaRequirements(e,t){if(this.putLog("debug","API Call: changeMediaRequirements"),"open"!==this.state)throw new o(new r(45010,"BadStateOnChangeMediaRequirements"));if(!this.sfupc)throw new o(new r(45011,"UnsupportedRoomSpecTypeOnChangeMediaRequirements"));if("sendonly"===this.sendrecv)throw new o(new r(45013,"InvalidReceivingOptionOnChangeMediaRequirements"));const i=this.sfupc.remote_track_metadata.find((t=>t.connection_id===e&&"video"===t.kind));if(!i)throw new o(new r(45012,"ConnectionNotFoundOnChangeMediaRequirements"));try{const e={message_type:"sfu.update_connect_options",options:{receiving:{videos:[{track_id:i.track_id,enabled:"required"===t}]}}};this.ws.sendMessage(e)}catch(e){this.internalError(61047,e)}}changeVideoSendFramerate(e){if(this.putLog("debug","API Call: changeVideoSendFramerate"),"open"!==this.state)throw new o(new r(45016,"BadStateOnChangeVideoSendFramerate"));if(e<0||1e4<e)throw new o(new r(45017,"InvalidMaxFramerateOnChangeVideoSendramerate"));try{this.reservedFramerate=e,this.localLSTracks.forEach((t=>{t.changeFramerate(e)}))}catch(e){this.internalError(61050,e)}}changeVideoSendBitrate(e){if(this.putLog("debug","API Call: changeVideoSendBitrate"),"open"!==this.state)throw new o(new r(45015,"BadStateOnChangeVideoSendBitrate"));if(!this.sfupc)throw new o(new r(45018,"UnsupportedRoomSpecTypeOnChangeVideoSendBitrate"));try{const t={message_type:"sfu.update_connect_options",options:{sending:{video:{max_bitrate_kbps:e}}}};this.ws.sendMessage(t)}catch(e){this.internalError(61048,e)}}getSendRecvFromOption(e){if(!e)return"sendrecv";const t=e.sending,i=e.receiving,n=!t||!t.hasOwnProperty("enabled")||!1!==t.enabled,s=!i||!i.hasOwnProperty("enabled")||!1!==i.enabled;return n&&s?"sendrecv":n&&!s?"sendonly":!n&&s?"recvonly":"void"}nextTrackOnReplaceTrack(e,t){return"unmute"===e?{nextMediaStreamTrack:t,trackEnabled:!0}:"softmute"===e?{nextMediaStreamTrack:t,trackEnabled:!1}:{nextMediaStreamTrack:null,trackEnabled:!1}}async replaceLSTrack(e,t){const{nextMediaStreamTrack:i,trackEnabled:n}=this.nextTrackOnReplaceTrack(t.muteType,e);e.enabled=n,await t.replaceSenderTrack(i),t.mediaStreamTrack=e}nextTrackOnChangeMute(e,t,i){return"unmute"===t?{nextMediaStreamTrack:i,trackEnabled:!0}:"softmute"===t?{nextMediaStreamTrack:i,trackEnabled:!1}:{nextMediaStreamTrack:null,trackEnabled:!1}}async changeMuteState(e,t,i){const{nextMediaStreamTrack:n,trackEnabled:s}=this.nextTrackOnChangeMute(e,t,i.mediaStreamTrack);i.mediaStreamTrack.enabled=s,await i.replaceSenderTrack(n),i.muteType=t}tagsToMute(e){try{const t=e.filter((e=>"muteState"===e.name))[0];if(!t)return null;let i="unmute";return"blank"===t.value?i="softmute":"paused"===t.value&&(i="hardmute"),i}catch(e){this.internalError(61039,e)}}tagsToMeta(e){try{return e.filter((e=>"app_front"===e.source)).reduce(((e,t)=>(e[t.name]=t.value,e)),{})}catch(e){this.internalError(61008,e)}}metaToTags(e,t="app_front"){try{const i=[];return Object.keys(e).forEach((n=>{i.push({name:n,value:e[n],source:t,use_notification:!0})})),i}catch(e){this.internalError(61009,e)}}async getLocalTrackMeta(e){try{return this.localLSTracks?(await this.sfupc.addTracks(this.localLSTracks),this.sfupc.assignTrackIdToTrack(e,this.localLSTracks),this.sfupc.makeLocalTrackMeta(e,this.localLSTracks)):{}}catch(e){this.internalError(61036,e)}}setState(e,t=null){try{this.putLog("state",`${e} <- ${this.state}`),this.state=e}catch(e){return void this.internalError(61001,e)}t&&"error"!==t&&this.emit(t)}onTrackP2P(e,t){let i={};try{const{track:n,streams:s}=t,a=s[0];i={connection_id:e.connection_id,mediaStreamTrack:n,stream:a};const r=this.connections.get(e.connection_id);r&&(r.state="trackadded",this.connections.set(e.connection_id,r))}catch(t){return void this.internalError(61027,t)}this.emit("addremotetrack",i)}async onTrackSFU(e,t){let i={},n={};try{const{track:s,streams:a}=t,r=t.streams[0].id,o=t.transceiver.mid,c=e.remote_track_metadata.find((e=>e.msid===r&&e.mid===o));if(!c)return;const d=c.connection_id,h=a[0];c.track=s,c.stream=h;const l=this.tagsToMeta(c.tags);if(i={connection_id:d,mediaStreamTrack:s,stream:h,meta:l,mute:this.tagsToMute(c.tags)},n=this.connections.get(d),n&&(n.state="trackadded",this.connections.set(d,n),n.reservedUpdate&&n.reservedUpdate.hasOwnProperty(c.track_id))){const e=n.reservedUpdate[c.track_id];e.meta&&(i.meta=e.meta),e.muteState&&(i.mute=e.muteState)}}catch(t){return void this.internalError(61026,t)}this.emit("addremotetrack",i)}onIceCandidateP2P(e,t){if("open"===this.state)try{if(null===t.candidate)return;this.ws.sendMessage({message_type:"p2p.icecandidate",peer_connection_id:e.connection_id,candidate:t.candidate})}catch(t){this.internalError(61028,t)}else this.putLog("debug","return onIceCandidateP2P (state!=open)")}onIceCandidateSFU(e){if("open"===this.state)try{this.ws.sendMessage({message_type:"sfu.icecandidate",candidate:e.candidate})}catch(e){this.internalError(61030,e)}else this.putLog("debug","return onIceCandidateSFU (state!=open)")}onChangeStability(e){const t=""===e.connection_id?"sfu":e.connection_id;"iceconnecttimeout"===e.stability?this.emitError(54001,"IceConnectionTimeout",e):this.emit("changestability",{connection_id:t,stability:e.stability})}makeConnectMessageOptions(e,t,i){const n={};if(e){const t={};if(e.hasOwnProperty("enabled")&&(t.enabled=e.enabled),e.hasOwnProperty("video")){const i={};e.video.hasOwnProperty("codec")&&(i.codec=e.video.codec),e.video.hasOwnProperty("priority")&&(i.priority=e.video.priority),e.video.hasOwnProperty("maxBitrateKbps")&&(i.max_bitrate_kbps=e.video.maxBitrateKbps),t.video=i}n.sending=t}if(t){const e={};t.hasOwnProperty("enabled")&&(e.enabled=t.enabled),n.receiving=e}if(null!=i){const e={};e.turn_protocols="all"===i?["udp","tcp","tls"]:[i],n.connecting=e}return n}onWSOpen(){try{this.putLog("wsevent","wsopen");const e={message_type:"connect",client_id:this.client_id,access_token:this.access_token,tags:this.metaToTags(this.connectionMetadata),sdk_info:{platform:"web",version:"1.4.0+20220420"},options:this.makeConnectMessageOptions(this.sendingOption,this.receivingOption,this.userIceServersProtocol)};this.ws.sendMessage(e),this.lastReceived=(new Date).getTime()}catch(e){this.internalError(61010,e)}}onWSError(e){try{this.putLog("wsevent","wserror: "+JSON.stringify(e)),this.setState("closing","error"),this.emitError(50001,"WebSocketError",e),this.setState("closed","close")}catch(e){this.internalError(61011,e)}}onWSClose(e){if(this.putLog("wsevent",`wsclose(${e.code}): ${e.reason}`),1e3===e.code);else if(e.code<3e3){const t=5e4+e.code,i="WebSocketBadClose"+t.toString();this.emitError(t,i,e)}else if(3e3<=e.code&&e.code<=3099);else if(3601===e.code)this.emitError(53601,"ConnectionLimitExceeded",e);else if(3719===e.code)this.emitError(53719,"ConnectionCreateTimeout",e);else if(3806===e.code)this.emitError(53806,"ServerUnavailable",e);else{const t=this.getParamError(e.code);t?this.emitError(4e4+e.code,t.err,e):this.internalError(61046,e)}this.sfupc&&(this.sfupc.close(),this.sfupc.stop(),this.sfupc=null),this.peers.forEach(((e,t)=>{e.close(),e.stop(),this.peers.delete(t)})),this.peers=new Map,this.setState("closed","close")}onConnectSuccess(e){try{const{ice_servers:t,room_session_id:i}=e;this.rtcConfiguration.iceServers=t,this.room_session_id=i}catch(e){return void this.internalError(61013,e)}const t=(new Date).getTime();e.connections.forEach((e=>{const{connection_id:i,tags:n}=e,s=this.getSendRecvFromOption(e.options),a=this.tagsToMeta(n);this.emit("addremoteconnection",{connection_id:i,meta:a}),this.connections.set(i,{state:"joined",join:t,sendrecv:s})})),this.setState("open","open")}onNotifyConnectionConnect(e){let t={};try{const{connection:i}=e,{connection_id:n,tags:s}=i,a=this.getSendRecvFromOption(i.options);t={connection_id:n,meta:this.tagsToMeta(s)},this.connections.set(n,{state:"joined",join:(new Date).getTime(),sendrecv:a})}catch(e){return void this.internalError(61014,e)}this.emit("addremoteconnection",t)}onNotifyConnectionLeave(e){let t={};try{const{connection:i}=e,{connection_id:n,tags:s}=i,a=this.tagsToMeta(s);if(this.sfupc){const e=this.sfupc.remote_track_metadata.map((e=>e.track));t={connection_id:n,meta:a,mediaStreamTracks:e}}else t={connection_id:n,meta:a};const r=this.peers.get(n);r&&(this.localLSTracks.forEach((e=>e.removeSenders(r))),r.stop(),r.close(),this.peers.delete(n));this.earlyCandidates.get(n)&&this.earlyCandidates.delete(n);this.connections.get(n)&&this.connections.delete(n)}catch(e){return void this.internalError(61015,e)}this.emit("removeremoteconnection",t)}onNotifyConnectionUpdate(e){let t={};try{const{connection_id:i,tags:n}=e;t={connection_id:i,meta:this.tagsToMeta(n)}}catch(e){return void this.internalError(61033,e)}this.emit("updateremoteconnection",t)}async onP2PRequestOffer(e){if("open"===this.state)try{const{peer_connection_id:t}=e;this.userIceTransportPolicy&&(this.rtcConfiguration.iceTransportPolicy=this.userIceTransportPolicy);const n=new i(t,this.rtcConfiguration,this.logger);this.peers.set(t,n),n.on("track",this.onTrackP2P.bind(this,n)),n.on("icecandidate",this.onIceCandidateP2P.bind(this,n)),n.on("changestability",this.onChangeStability.bind(this)),this.localLSTracks&&0!==this.localLSTracks.length&&await n.addTracks(this.localLSTracks),this.localLSTracks.forEach((async e=>{await this.changeMuteState("unmute",e.muteType,e)}));const s=await n.getOffer();this.ws.sendMessage({message_type:"p2p.offer",peer_connection_id:t,sdp:s}),this.localLSTracks.forEach((async e=>{this.reservedFramerate&&e.changeFramerate(this.reservedFramerate)}))}catch(e){this.internalError(61016,e)}else this.putLog("debug","return onP2PRequestOffer (state!=open)")}async onP2PRelayOffer(e){if("open"===this.state)try{const{peer_connection_id:t,sdp:n}=e;this.userIceTransportPolicy&&(this.rtcConfiguration.iceTransportPolicy=this.userIceTransportPolicy);const s=new i(t,this.rtcConfiguration,this.logger);this.peers.set(t,s),s.on("track",this.onTrackP2P.bind(this,s)),s.on("icecandidate",this.onIceCandidateP2P.bind(this,s)),s.on("changestability",this.onChangeStability.bind(this)),this.localLSTracks&&0!==this.localLSTracks.length&&await s.addTracks(this.localLSTracks),this.localLSTracks.forEach((async e=>{await this.changeMuteState("unmute",e.muteType,e)}));const a=await s.getAnswer(n);this.ws.sendMessage({message_type:"p2p.answer",peer_connection_id:t,sdp:a});const r=this.earlyCandidates.get(t);r&&(r.forEach((async e=>{await s.setIceCandidate(e)})),this.earlyCandidates.delete(t)),this.localLSTracks.forEach((async e=>{this.reservedFramerate&&e.changeFramerate(this.reservedFramerate)}))}catch(e){this.internalError(61017,e)}else this.putLog("debug","return onP2PRelayOffer (state!=open)")}async onP2PRelayAnswer(e){try{const{peer_connection_id:t,sdp:i}=e,n=this.peers.get(t);await n.setAnswer(i)}catch(e){this.internalError(61018,e)}}async onP2PRelayIcecandidate(e){try{const{peer_connection_id:t,candidate:i}=e;if(null===i||""===i.candidate)return;const n=this.peers.get(t);if(n)await n.setIceCandidate(i);else{const e=this.earlyCandidates.get(t);e?e.push(i):this.earlyCandidates.set(t,[i])}}catch(e){this.internalError(61019,e)}}onP2PRequestUpdateAnswer(e){try{console.debug(e)}catch(e){this.internalError(61021,e)}}onP2PRelayUpdateAnswer(e){try{console.debug(e)}catch(e){this.internalError(61022,e)}}async onSFUOffer(e){if("open"===this.state)try{const{sdp:t}=e;if(this.rtcConfiguration.iceTransportPolicy="relay",this.sfupc=new i("",this.rtcConfiguration,this.logger),this.sfupc.setRemoteTrackMetadata(e.remote_track_metadata),this.sfupc.on("track",this.onTrackSFU.bind(this,this.sfupc)),this.sfupc.on("icecandidate",this.onIceCandidateSFU.bind(this)),this.sfupc.on("changestability",this.onChangeStability.bind(this)),"recvonly"!==this.sendrecv){const t=await this.getLocalTrackMeta(e.local_track_slots);this.ws.sendMessage({message_type:"sfu.pre_answer",local_track_metadata:t})}this.localLSTracks.forEach((async e=>{await this.changeMuteState("unmute",e.muteType,e)}));const n=await this.sfupc.getAnswer(t);this.ws.sendMessage({message_type:"sfu.answer",sdp:n}),this.localLSTracks.forEach((async e=>{this.reservedFramerate&&e.changeFramerate(this.reservedFramerate)}))}catch(e){this.internalError(61020,e)}else this.putLog("debug","return onSFUOffer (state!=open)")}async onSFUUpdateOffer(e){if("open"===this.state)try{const{sdp:t}=e;this.sfupc.setRemoteTrackMetadata(e.remote_track_metadata);const i=await this.sfupc.getAnswer(t);this.ws.sendMessage({message_type:"sfu.update_answer",sdp:i})}catch(e){this.internalError(61023,e)}else this.putLog("debug","return onSFUUpdateOffer (state!=open)")}async onSFURelayIcecandidate(e){try{const{candidate:t}=e;if(null===t||""===t.candidate)return;await this.sfupc.setIceCandidate(t)}catch(e){this.internalError(61024,e)}}onNotifySFUTrackUpdate(e){let t,i,n={},s={};try{const{track_id:a,tags:r}=e,o=this.sfupc.remote_track_metadata.find((e=>e.track_id===a));if(!o)return;i=this.tagsToMeta(r),n={connection_id:o.connection_id,mediaStreamTrack:o.track,stream:o.stream,meta:i},t=this.tagsToMute(r),s={connection_id:o.connection_id,mediaStreamTrack:o.track,stream:o.stream,mute:t};const c=this.connections.get(o.connection_id);if(c&&"trackadded"!==c.state){c.hasOwnProperty("reservedUpdate")||(c.reservedUpdate={});const e={};return Object.keys(i).length&&(e.meta=i),t&&(e.muteState=t),c.reservedUpdate[a]=e,void this.connections.set(o.connection_id,c)}}catch(e){return void this.internalError(61034,e)}Object.keys(i).length&&this.emit("updateremotetrack",n),t&&this.emit("updatemute",s)}onPing(e){if("open"===this.state)try{this.ws.sendMessage({message_type:"pong"})}catch(e){this.internalError(61025,e)}else this.putLog("debug","return onPing (state!=open)")}onError(e){const{error_code:t}=e;if(this.putLog("wsevent","sigerror: "+JSON.stringify(e)),"room_state_unacceptable_message_type"===e.reason&&"sfu.update_track"===e.client_message_type)return void this.emitError(45005,"BadStateOnChangeMute",e);const i=this.getSignalingError(t);i?""!==i.err&&this.emitError(45e3+t,i.err,e):this.internalError(61045,e)}onDebugInfo(e){try{const{debug_info:t}=e;this.putLog("debug",JSON.stringify(t))}catch(e){this.internalError(61035,e)}}monitor(){const e=(new Date).getTime(),t=9e4<e-this.ws.lastReceived;if(("open"===this.state||"connecting"===this.state)&&t)return this.emitError(54002,"SignalingTimeout",{}),void this.setState("closed","close");"sendonly"!==this.sendrecv&&this.connections.forEach(((t,i)=>{"recvonly"!==t.sendrecv&&"joined"===t.state&&t.join&&1e4<e-t.join&&(t.state="timeout",this.connections.set(i,t),this.emitError(54e3,"OnTrackTimeout",{connection_id:i}))}))}getParamError(e){return new Map([[3201,{err:"InvalidClientID"}],[3204,{err:"TooManyMeta"}],[3209,{err:"InvalidMetaName"}],[3213,{err:"TooLongMetaValue"}],[3223,{err:"InvalidVideoCodecOnConnect"}],[3224,{err:"InvalidVideoPriorityOnConnect"}],[3225,{err:"InvalidVideoMaxBitrateKBPSOnConnect"}],[3229,{err:"InvalidConnectingTurnProtocols"}],[3232,{err:"InvalidSendingReceivingEnabled"}],[3400,{err:"InvalidAccessTokenNotJWT"}],[3401,{err:"InvalidAccessTokenBadAlg"}],[3402,{err:"InvalidAccessTokenBadSignature"}],[3403,{err:"InvalidAccessTokenNoNbf"}],[3404,{err:"InvalidAccessTokenBadNbf"}],[3405,{err:"InvalidAccessTokenBadNbfTime"}],[3406,{err:"InvalidAccessTokenNoExp"}],[3407,{err:"InvalidAccessTokenBadExp"}],[3408,{err:"InvalidAccessTokenBatExpTime"}],[3409,{err:"InvalidAccessTokenNoConnectionID"}],[3410,{err:"InvalidAccessTokenBadConnectionID"}],[3411,{err:"InvalidAccessTokenNoRoomID"}],[3412,{err:"InvalidAccessTokenBadRoomID"}],[3413,{err:"InvalidAccessTokenBadVersion"}],[3418,{err:"InvalidAccessTokenNoRoomSpec"}],[3419,{err:"InvalidAccessTokenBadRoomSpec"}],[3420,{err:"InvalidAccessTokenNoRoomSpecType"}],[3421,{err:"InvalidAccessTokenBadRoomSpecType"}],[3422,{err:"InvalidAccessTokenBadRoomSpecMaxConnections"}],[3423,{err:"InvalidAccessTokenBadRoomSpecClassificationLabel"}],[3424,{err:"InvalidAccessTokenBadRoomSpecMediaControl"}],[3425,{err:"InvalidAccessTokenBadRoomSpecMediaControlBitrateReservationMBPS"}],[3426,{err:"InvalidAccessTokenExceedTimeLimitation"}],[3599,{err:"InvalidAccessToken"}],[3600,{err:"RoomSpecMissMatchOnConnect"}],[3602,{err:"DuplicateConnectionIDOnConnect"}]]).get(e)}getSignalingError(e){return new Map([[104,{err:"InvalidMetaNameOnUpdateConnection"}],[108,{err:"TooLongMetaNameOnUpdateConnection"}],[109,{err:"NotFoundMetaOnUpdateConnection"}],[511,{err:"TooLongMetaValueOnUpdateTrackMeta"}],[512,{err:"NotFoundMetaOnUpdateTrackMeta"}],[605,{err:"TooManyMetaOnConnect"}],[614,{err:"TooLongMetaValueOnConnect"}],[703,{err:""}],[708,{err:"InvalidMaxBitrateKBPSOnChangeVideoSendBitrate"}]]).get(e)}putLog(e,t){this.logger&&("state"===e?this.stateTailHistory=this.logger.putLog(this.stateHeadHistory,this.stateTailHistory,t):"wsevent"===e?this.wsEventTailHistory=this.logger.putLog(this.wsEventHeadHistory,this.wsEventTailHistory,t):this.debugInfoTailHistory=this.logger.putLog(this.debugInfoHeadHistory,this.debugInfoTailHistory,t))}}const h="JqwDrc3-TEgbXiDnrrZnSlGvxpl8HouXs6RvYqauIdY";var l,u,p,g,m,y,_,f,v,S;const T=document.querySelector.bind(document);let k,w=[],b=null,E=[],H="",C="h264",M="normal",L=0,P=!0;function I(e){E.forEach((t=>{if(t.connection_id===e.connection_id){e.name&&(t.name=e.name),e.audioMute&&(t.audioMute=e.audioMute),e.hand&&(t.hand=e.hand),e.cameraName&&(t.cameraName=e.cameraName);T(`#${e.connection_id}_text`).innerText=((e,t,i,n,s)=>{let a="";"initial"!==s&&"stable"!==s&&(a=("unstable"===s?"⚠":"❌")+" ");return a=`${e}`,n&&""!==n&&(a=`${a} (${n})`),a="unmute"===t?`${a} 🔊`:`${a} 🔇`,"raise"===i&&(a=`${a} ✋`),a})(t.name,t.audioMute,t.hand,t.cameraName)}}))}function O(e,t){T("#errMsg").innerText=e.error,T("#reportStr").innerText=t,T("#error").style.display="block",T("#remoteStreams").innerHTML="",T("#localStream").srcObject=null,T("#main").style.display="none"}async function R(){try{const e=await fetch(`http://localhost:8000/login?room=${H}`),t=await e.text(),i={video:{deviceId:{exact:F},width:640,height:480},audio:{deviceId:{exact:A}}},n=await navigator.mediaDevices.getUserMedia(i);w=n.getTracks().map((e=>{const t="video"===e.kind?$:U;return new s(e,n,{mute:t,meta:{cameraName:""}})})),b=function(){const e=new d;return e.on("error",(e=>{O(e.detail,e.toReportString())})),e.on("open",(e=>{T("#connect").disabled=!1,T("#connect").innerText="disconnect"})),e.on("close",(e=>{T("#connect").disabled=!1,T("#connect").innerText="connect"})),e.on("addlocaltrack",(({mediaStreamTrack:e,stream:t})=>{T("#localStream").srcObject=t})),e.on("addremoteconnection",(({connection_id:e,meta:t})=>{let i=T(`#${e}`);if(i)return;i=document.createElement("div"),i.id=e;const n=document.createElement("video");n.id=`${e}_video`,n.setAttribute("playsinline",""),n.ondblclick=()=>{n.requestFullscreen()},i.appendChild(n);const s=document.createElement("div");s.id=`${e}_text`,i.appendChild(s),T("#remoteStreams").appendChild(i),E.push({connection_id:e,name:t.name,audioMute:"unmute",hand:"none",cameraName:"",stability:"initial"})})),e.on("updateremoteconnection",(({connection_id:e,meta:t})=>{I({connection_id:e,hand:t.hand})})),e.on("removeremoteconnection",(({connection_id:e,meta:t,mediaStreamTrack:i})=>{let n=T(`#${e}`);n||(T("#remoteStreams").removeChild(n),E=E.filter((t=>t.connection_id!==e)))})),e.on("addremotetrack",(async({connection_id:e,mediaStreamTrack:t,stream:i,mute:n})=>{const s=T(`#${e}_video`);s&&(s.srcObject?s.srcObject.addTrack(t):s.srcObject=i,await s.play(),"video"!==t.kind&&I({connection_id:e,audioMute:n}))})),e.on("updateremotetrack",(({connection_id:e,mediaStreamTrack:t,stream:i,meta:n})=>{"audio"!==t.kind&&I({connection_id:e,cameraName:n.cameraName})})),e.on("updatemute",(({connection_id:e,mediaStreamTrack:t,mute:i})=>{"video"!==t.kind&&I({connection_id:e,audioMute:i})})),e.on("changestability",(({connection_id:e,stability:t})=>{I({connection_id:e,stability:t})})),e}();const a=`user${Date.now()}`,r="none";T("#localText").innerText=a;const o=function(e){const t={localLSTracks:w,meta:e,iceServersProtocol:k};P||(t.receiving={},t.receiving.enabled=!1);const i={};return 0!==L&&(i.maxBitrateKbps=L),"normal"!==M&&(i.priority=M),"h264"!==C&&(i.codec=C),i!=={}&&(t.sending={},t.sending.video=i),t}({name:a,hand:r});b.connect(h,t,o)}catch(e){e instanceof o?O(e.detail,e.toReportString()):console.error(e)}return!0}function x(){return"disconnect"===T("#connect").innerText}null===(l=T("#connect"))||void 0===l||l.addEventListener("click",(async e=>{"connect"===T("#connect").innerText?await R()&&(T("#connect").disabled=!0,T("#options").style.display="none"):function(){if(!b)return console.error("no client"),!1;const e=b.getState();return"open"!==e?(console.error(`state(${e}) != "open"`),!1):(w.forEach((e=>{e.mediaStreamTrack.stop()})),b.disconnect(),!0)}()&&(T("#connect").disabled=!0,T("#options").style.display="none",T("#remoteStreams").textContent="",T("#localStream").srcObject=null)}));let U="softmute",$="softmute",A="default",F="default";function B(e,t){const i=w.filter((t=>t.mediaStreamTrack.kind===e))[0];null==b||b.changeMute(i,t)}async function N(e,t){if("unmute"===t)try{const t={video:{deviceId:{exact:e},width:640,height:480},audio:!1},i=await navigator.mediaDevices.getUserMedia(t);T("#localStream").srcObject=i}catch(e){console.error(e)}else T("#localStream").srcObject=null}async function D(){const e=(e,t,i)=>{var n;let s=!1;const a=e.options.length;for(let i=0;i<a;i++)if((null===(n=e.options.item(i))||void 0===n?void 0:n.value)===t){s=!0;break}if(s)return;const r=document.createElement("option");r.value=t,r.text=i,e.appendChild(r)},t=T("#audioSource");for(;t.options.length;)t.remove(0);const i=T("#videoSource");for(;i.options.length;)i.remove(0);await navigator.mediaDevices.getUserMedia({video:{width:640,height:480},audio:!1});const n=await navigator.mediaDevices.enumerateDevices();for(let s=0;s!==n.length;++s){const a=n[s],r=a.deviceId;if("audioinput"===a.kind&&t){"default"===A&&(A=r);e(t,r,a.label)}else if("videoinput"===a.kind&&i){"default"===F&&(F=r);e(i,r,a.label)}}}null===(u=T("#amute"))||void 0===u||u.addEventListener("change",(async e=>{var t;const i=null===(t=T("input:checked[name=amute]"))||void 0===t?void 0:t.value;x()?B("audio",i):U=i})),null===(p=T("#vmute"))||void 0===p||p.addEventListener("change",(async e=>{var t,i;const n=null===(t=T("input:checked[name=vmute]"))||void 0===t?void 0:t.value;if(x())B("video",n);else{$=n;const e=null===(i=T("#videoSource"))||void 0===i?void 0:i.value;await N(e,n)}})),null===(g=T("#meta"))||void 0===g||g.addEventListener("change",(async e=>{var t;const i=null===(t=T("input:checked[name=meta]"))||void 0===t?void 0:t.value;x()&&function(e){null==b||b.updateMeta({hand:e})}(i)})),null===(m=T("#audioSource"))||void 0===m||m.addEventListener("change",(async e=>{var t;const i=null===(t=T("#audioSource"))||void 0===t?void 0:t.value;x()||(A=i)})),null===(y=T("#videoSource"))||void 0===y||y.addEventListener("change",(async e=>{var t;const i=T("#videoSource"),n=i.value;if(x())!function(e,t){const i=w.filter((t=>t.mediaStreamTrack.kind===e))[0];null==b||b.updateTrackMeta(i,{cameraName:t})}("video",i[i.selectedIndex].innerText);else{F=n;const e=null===(t=T("input:checked[name=vmute]"))||void 0===t?void 0:t.value;await N(n,e)}})),null===(_=T("#option"))||void 0===_||_.addEventListener("click",(async e=>{const t="block"===T("#options").style.display?"none":"block";T("#options").style.display=t})),null===(f=T("#start"))||void 0===f||f.addEventListener("click",(async e=>{let t="";if(H=T("#roomId").value,""===H)return;if(/^[a-zA-Z0-9.%+^_"`{|}~<>\-]{1,255}$/.test(H)){if(t=T("#videoCodec").value,""!==t){if(!(e=>"h264"===e||"vp8"===e||"vp9"===e||"h265"===e||"av1"===e)(t))return;C=t}if(t=T("#sendingPriority").value,""!==t){if(!(e=>"normal"===e||"high"===e)(t))return;M=t}if(t=T("#maxBitrateKbps").value,""!==t){const e=parseInt(t,10);if(e<100||2e4<e)return;L=e}if(t=T("#receivingEnabled").value,""!==t)if("true"===t)P=!0;else{if("false"!==t)return;P=!1}if(t=T("#iceServersProtocol").value,""!==t)if("all"===t)k=t;else if("udp"===t)k=t;else if("tcp"===t)k=t;else{if("tls"!==t)return;k=t}T("#prepare").style.display="none",T("#main").style.display="block"}})),null===(v=T("#dlLog"))||void 0===v||v.addEventListener("click",(e=>{const t=`${null==b?void 0:b.getHeadReport()}${null==b?void 0:b.getTailReport()}`,i=document.createElement("a");i.download="log.txt",i.href=URL.createObjectURL(new Blob([t],{type:"text.plain"})),i.dataset.downloadurl=["text/plain",i.download,i.href].join(":"),i.click()})),null===(S=T("#dlStatsLog"))||void 0===S||S.addEventListener("click",(e=>{const t=`${null==b?void 0:b.getStatsReport()}`,i=document.createElement("a");i.download="statslog.txt",i.href=URL.createObjectURL(new Blob([t],{type:"text.plain"})),i.dataset.downloadurl=["text/plain",i.download,i.href].join(":"),i.click()})),document.addEventListener("DOMContentLoaded",(async e=>{await D()})),navigator.mediaDevices.addEventListener("devicechange",(async e=>{await D()})),document.addEventListener("fullscreenchange",(async e=>{const t=e.target.getAttribute("id");if(!t)return;const i=t.split("_")[0],n=document.fullscreenElement?"unrequired":"required";E.filter((e=>e.connection_id!==i)).forEach((e=>{null==b||b.changeMediaRequirements(e.connection_id,n)}))})),document.addEventListener("fullscreenerror",(async e=>{console.error("fullscreenerror")}));
